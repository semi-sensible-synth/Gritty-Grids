# Modified for triggerspace (NanoGris-MIDI)

- Clock pin is now D8 (PB0)
- Serial Tx (PD1) is now MIDI out pin
- Clock input, reset input and button (INPUT_SW_RESET) 
  are now handled as individual boolean digital input pins rather than
  packed into a bit-array as 'inputs'.
- MIDI out drum triggers on channel 10

# Gritty Grids - An Improved MIDI Implementation for Grids
Grids is a topographic (drum) sequencer for Eurorack modular synthesizers 
developed by Mutable Instruments.

If you use a setup that is primarily based on MIDI you might want to 
synchronize Grids to your MIDI master clock.
The stock firmware of Grids offers only rudimentary support for a MIDI 
interface. It resets the drum engine when it receives a MIDI Start message 
and uses MIDI Clock messages to advance. However it does not care about 
MIDI Stop or MIDI Continue messages. If, after pressing stop on your 
MIDI master device, the master does not cease sending MIDI Clocks 
(quite a common behaviour) Grids will go on 
drumming forever.

The "Gritty Grids" firmware improves on this situation by properly 
reacting to all MIDI Start, Stop, Continue and Clock messages. See 
the [Gritty Grids demo video](https://youtu.be/vbTWLX3Ts00) on YouTube.

### A MIDI Interface for Grids
Fortunately Grids offers three pads on the back of its printed circuit 
board that are waiting to become a MIDI IN interface.

![Grids MIDI port](/images/grids-midi-port.jpg)

Just connect the following simple circuit. It can easily be built on a 
prototyping board.

![MIDI circuit](/images/midi-circuit.jpg)

As a quick hack you might even succeed if you only take a 5-pin female 
DIN jack making the following connections:
* pin 2 (shield / ground) to Grids GND
* pin 5 (current sink) to Grids RX>

But beware: This is a hack. It DOES NOT COMPLY with the specification 
of the MIDI standard. You lose the galvanic isolation of the MIDI 
interface. It might or might not work. Try at your own risk.


### Flashing the Firmware
Use the in-system programmer of your choice (e. g. I use the 
AVRisp MkII from Atmel) to flash the "gritty-grids.hex" file to 
the AVR microcontroller on Grids. If you are not familiar with 
flashing AVR controllers search the web for instructions.

If you want to go back to the original stock firmware flash 
"grids_original.hex".

On Ubuntu 22.04, with a CH341 Nano clone, I needed to first disable `brltty` so it wouldn't claim the USB device. Do:
```bash
sudo systemctl stop brltty-udev.service
sudo systemctl mask brltty-udev.service
sudo systemctl stop brltty.service
sudo systemctl disable brltty.service
```

Then build and flash like:
```bash
make

avrdude -C /etc/avrdude.conf -v \
        -p atmega328p \
        -c arduino \
        -P /dev/ttyUSB0 \
        -b 57600 -D \
        -U flash:w:build/grids/grids.hex:i
```

Or, if you are using a USBasp programmer:
```bash
make

avrdude -C /etc/avrdude.conf -v \
        -p atmega328p \
        -c usbasp \
        -u \
        -U flash:w:build/grids/grids.hex:i
```


### Gritty Grids User Manual
Enter the external clocking mode by turning the tempo knob to 
its minimum position, thus enabling Grids to be clocked by either external clock pulses or by MIDI messages. After receiving a  MIDI Start or MIDI Continue 
message Grids switches into a "clocked_by_midi" mode. In this mode its 
drum engine advances with every MIDI clock message. External clocking 
via the clock input jack is disabled.

Receiving a MIDI Start message resets the Grids drum engine whereas 
MIDI continue resumes from the current state it was left in.

The 
functionality of the reset input as well as the TAP/reset button was changed, because a manually tapped-in tempo or an external reset applied while in "clocked_by_midi" mode
would break the synchronization with the MIDI master. Instead they now provide a "mute" function that suppresses all trigger and 
accent outputs. While muted all three output leds will light up 
permanently.

When entering the external clocking mode (turning the tempo knob fully left) the outputs are muted by default. Press the button to unmute them.

To leave the "clocked_by_midi" mode, turn the tempo knob to the right. This activates internal clocking and unmutes all outputs.


### Other Changes
Besides the MIDI stuff I also disabled retriggering of the outputs 
when a signal at the reset input has been received. This avoids 
the annoying double triggers.

Finally I increased the duration of the trigger pulses from 1 ms to 
5 ms because some Eurorack modules are reported to have troubles recognizing the short trigger pulses generated by Grids original firmware.


### Syncing other modules to your MIDI master
If you have a sequencer module in your rack you might want to set Grids output configuration to ACC / CLK / RST (see Grids manual on how to do this). This leaves you with a 
clock and reset output that are in sync with your MIDI master clock. Use these outputs to synchronize your sequencer modules.


### Website
Original Grids website: https://mutable-instruments.net/modules/grids/


### Author
* Author of the original Grids project is Émilie Gillet.
* Author of the Gritty Grids modification is Sonic Insurgence.


### License
This program is free software: you can redistribute it and/or modify 
it under the terms of the GNU General Public License as published by 
the Free Software Foundation, either version 3 of the License, or 
(at your option) any later version.


### Acknowledgments
Original Grids design by Émilie Gillet from Mutable Instruments. 
Many thanks for making it open source!

